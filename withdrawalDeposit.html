<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보증금 출금</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>보증금 출금</h1>

        <div id="message" class="message"></div>
        
        <div id="withdrawalResultSection" style="display: none; margin-top: 30px; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #404040;">
            <div style="color: #e0e0e0; line-height: 1.8; margin-bottom: 20px; text-align: center; font-size: 16px;">
                <div id="withdrawalResultMessage1"></div>
                <div id="withdrawalResultMessage2" style="margin-top: 10px;"></div>
            </div>
            <button type="button" class="btn" id="nextStepBtn" style="display: none; width: 100%;">다음단계로</button>
            <button type="button" class="btn" id="backBtn" style="display: none; width: 100%; background: transparent; border: 1px solid #404040;">되돌아가기</button>
        </div>
    </div>

    <div class="version-info" id="versionInfo"></div>

    <script src="js/shared.js"></script>
    <script src="js/withdrawal.js"></script>
    <script src="js/withdrawalDeposit.js"></script>
    <script>
        // 버전 정보 표시
        document.getElementById('versionInfo').textContent = `v${APP_VERSION} (${BUILD_DATE})`;

        // 페이지 로드 시 자동으로 보증금 출금 처리 시작
        document.addEventListener('DOMContentLoaded', async () => {
            const address = localStorage.getItem('userAddress');
            const messageEl = document.getElementById('message');

            // 주소 확인
            if (!address) {
                messageEl.className = 'message error show';
                messageEl.textContent = '주소 정보가 없습니다. 이전 페이지로 돌아가주세요.';
                return;
            }

            try {
                // 현재 보증금 조회
                const currentAmount = await getCurrentAmount();
                const currentDeposit = currentAmount.deposit || 0;

                if (currentDeposit === 0) {
                    // 보증금이 없으면 잔여 금액 출금 페이지로 이동
                    window.location.href = 'withdrawalRemain.html';
                    return;
                }

                // 보증금 출금 진행 중 표시
                messageEl.className = 'message loading show';
                messageEl.textContent = `보증금 ${currentDeposit.toLocaleString()}원 출금 중...`;

                // 보증금 출금 처리
                await processDepositWithdrawal();

                // 출금 후 금액 재조회
                const remainingInfo = await getCurrentAmount();
                const remainingDeposit = remainingInfo.deposit || 0;
                const remainingPrize = remainingInfo.prize || 0;
                const withdrawnAmount = currentDeposit - remainingDeposit;

                // 출금 결과 메시지 표시
                messageEl.className = 'message';
                messageEl.textContent = '';
                
                const resultSection = document.getElementById('withdrawalResultSection');
                const resultMessage1 = document.getElementById('withdrawalResultMessage1');
                const resultMessage2 = document.getElementById('withdrawalResultMessage2');
                const nextStepBtn = document.getElementById('nextStepBtn');
                const backBtn = document.getElementById('backBtn');
                
                // 취소된 금액이 0원인 경우
                if (withdrawnAmount === 0) {
                    // 첫 번째 메시지: 결제 취소 실패
                    resultMessage1.textContent = '보증금 결제 취소에 실패했어요.';
                    
                    // 두 번째 메시지: 다른 방법으로 출금 안내
                    const remainingParts = [];
                    if (remainingDeposit > 0) {
                        remainingParts.push(`보증금 ${remainingDeposit.toLocaleString()}원`);
                    }
                    if (remainingPrize > 0) {
                        remainingParts.push(`상금 ${remainingPrize.toLocaleString()}원`);
                    }
                    resultMessage2.textContent = `다른 방법으로 ${remainingParts.join('과 ')}을 출금할게요.`;
                    
                    // 다른 방법으로 출금하기 버튼 표시
                    nextStepBtn.textContent = '다른 방법으로 출금하기';
                    nextStepBtn.style.display = 'block';
                    backBtn.style.display = 'none';
                    
                    // 버튼 클릭 시 이동
                    nextStepBtn.onclick = () => {
                        window.location.href = 'withdrawalRemain.html';
                    };
                } else {
                    // 취소된 금액이 0원이 아닌 경우
                    // 첫 번째 메시지: 출금 결과
                    resultMessage1.textContent = `${currentDeposit.toLocaleString()}원 중 ${withdrawnAmount.toLocaleString()}원이 결제 취소 형태로 출금되었어요.`;
                    
                    // 남은 상금 또는 보증금이 있는 경우
                    if (remainingDeposit > 0 || remainingPrize > 0) {
                        // 두 번째 메시지: 잔여 금액 안내
                        const remainingParts = [];
                        if (remainingDeposit > 0) {
                            remainingParts.push(`보증금 ${remainingDeposit.toLocaleString()}원`);
                        }
                        if (remainingPrize > 0) {
                            remainingParts.push(`상금 ${remainingPrize.toLocaleString()}원`);
                        }
                        resultMessage2.textContent = `${remainingParts.join('과 ')}은 다음 단계에서 출금할게요.`;
                        
                        // 다음 단계로 버튼 표시
                        nextStepBtn.textContent = '다음단계로';
                        nextStepBtn.style.display = 'block';
                        backBtn.style.display = 'none';
                        
                        // 다음 단계 버튼 클릭 시 이동
                        nextStepBtn.onclick = () => {
                            window.location.href = 'withdrawalRemain.html';
                        };
                    } else {
                        // 남은 상금 또는 보증금이 없는 경우
                        resultMessage2.textContent = '';
                        
                        // 되돌아가기 버튼 표시
                        nextStepBtn.style.display = 'none';
                        backBtn.style.display = 'block';
                        
                        // 되돌아가기 버튼 클릭 시 공지 페이지로 이동
                        backBtn.onclick = () => {
                            window.location.href = 'notice.html';
                        };
                    }
                }
                
                resultSection.style.display = 'block';
            } catch (error) {
                messageEl.className = 'message error show';
                messageEl.textContent = error.message || '처리 중 오류가 발생했습니다.';
            }
        });
    </script>
</body>
</html>

