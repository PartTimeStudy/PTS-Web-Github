<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보증금 출금</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>보증금 출금</h1>

        <div id="message" class="message"></div>
        
        <div id="withdrawalResultSection" style="display: none; margin-top: 30px; padding: 20px; background: #1a1a1a; border-radius: 8px; border: 1px solid #404040;">
            <div style="color: #e0e0e0; line-height: 1.8; margin-bottom: 20px; text-align: center; font-size: 16px;">
                <div id="withdrawalResultMessage1"></div>
                <div id="withdrawalResultMessage2" style="margin-top: 10px;"></div>
            </div>
            <button type="button" class="btn" id="nextStepBtn" style="display: none; width: 100%;">채권 신고하기</button>
            <button type="button" class="btn" id="backBtn" style="display: none; width: 100%; margin-top: 0; background: #2d2d2d; border: 1px solid #404040;">닫기</button>
            <div id="bondButtons" style="display: none; flex-direction: row; gap: 10px; margin-top: 10px;">
                <button type="button" class="btn" id="closeBtn" style="flex: 1; background: #2d2d2d; border: 1px solid #404040;">닫기</button>
                <button type="button" class="btn" id="bondBtn" style="flex: 1;">채권 신고하기</button>
            </div>
        </div>
    </div>

    <div class="version-info" id="versionInfo"></div>

    <script src="js/shared.js"></script>
    <script src="js/withdrawal.js"></script>
    <script src="js/withdrawalDeposit.js"></script>
    <script>
        // 버전 정보 표시 (dev 환경에서만)
        const versionInfoEl = document.getElementById('versionInfo');
        if (isDevEnvironment()) {
            versionInfoEl.textContent = `v${APP_VERSION} (${BUILD_DATE})`;
        } else {
            versionInfoEl.style.display = 'none';
        }

        // 페이지 로드 시 자동으로 보증금 출금 처리 시작
        document.addEventListener('DOMContentLoaded', async () => {
            const messageEl = document.getElementById('message');

            try {
                // 현재 보증금 조회
                const userInfo = await getUserInfo();
                const currentDeposit = userInfo.remainDeposit || 0;

                if (currentDeposit === 0) {
                    // 보증금이 없으면 주소 입력 페이지로 이동
                    window.location.href = 'address.html';
                    return;
                }

                // 보증금 출금 진행 중 표시
                messageEl.className = 'message loading show';
                messageEl.textContent = `보증금 ${currentDeposit.toLocaleString()}원 출금 중...`;

                // 보증금 출금 처리
                await processDepositWithdrawal();

                // 출금 후 금액 재조회
                const remainingInfo = await getUserInfo();
                const remainingDeposit = remainingInfo.remainDeposit || 0;
                const remainingPrize = remainingInfo.remainPrize || 0;
                const withdrawnAmount = currentDeposit - remainingDeposit;

                // 출금 결과 메시지 표시
                messageEl.className = 'message';
                messageEl.textContent = '';
                
                const resultSection = document.getElementById('withdrawalResultSection');
                const resultMessage1 = document.getElementById('withdrawalResultMessage1');
                const resultMessage2 = document.getElementById('withdrawalResultMessage2');
                const nextStepBtn = document.getElementById('nextStepBtn');
                const backBtn = document.getElementById('backBtn');
                const bondButtons = document.getElementById('bondButtons');
                const closeBtn = document.getElementById('closeBtn');
                const bondBtn = document.getElementById('bondBtn');
                
                // 채권 신고 가능한 금액 메시지 생성 함수
                const createBondMessage = (deposit, prize, prefix = '') => {
                    const parts = [];
                    if (deposit > 0) parts.push(`보증금 ${deposit.toLocaleString()}원`);
                    if (prize > 0) parts.push(`상금 ${prize.toLocaleString()}원`);
                    return parts.length > 0 ? `${prefix}${parts.join('과 ')}은 채권으로 신고할 수 있어요.` : '';
                };
                
                // 모든 버튼 숨기기
                const hideAllButtons = () => {
                    nextStepBtn.style.display = 'none';
                    backBtn.style.display = 'none';
                    bondButtons.style.display = 'none';
                };
                
                // 남은 금액이 있는지 확인
                const hasRemainingAmount = remainingDeposit > 0 || remainingPrize > 0;
                
                // 케이스 1: 출금 실패 (출금 금액이 0원)
                if (withdrawnAmount === 0) {
                    resultMessage1.textContent = '보증금 출금이 (일부)처리되지 않았어요.';
                    resultMessage2.textContent = createBondMessage(remainingDeposit, remainingPrize);
                    
                    hideAllButtons();
                    
                    // 닫기 버튼은 항상 표시
                    closeBtn.onclick = () => window.location.href = 'notice.html';
                    
                    // 채권 신고하기 버튼은 남은 금액이 있을 때만 표시
                    if (hasRemainingAmount) {
                        bondButtons.style.display = 'flex';
                        bondBtn.onclick = () => window.location.href = 'address.html';
                    } else {
                        backBtn.textContent = '닫기';
                        backBtn.style.display = 'block';
                        backBtn.onclick = () => window.location.href = 'notice.html';
                    }
                }
                // 케이스 2: 전체 출금 성공 (남은 보증금이 0원)
                else if (remainingDeposit === 0) {
                    resultMessage1.textContent = '보증금 출금이 완료되었어요.';
                    
                    hideAllButtons();
                    
                    if (remainingPrize > 0) {
                        resultMessage2.textContent = createBondMessage(0, remainingPrize);
                        // 닫기와 채권 신고하기 버튼 모두 표시
                        bondButtons.style.display = 'flex';
                        closeBtn.onclick = () => window.location.href = 'notice.html';
                        bondBtn.onclick = () => window.location.href = 'address.html';
                    } else {
                        resultMessage2.textContent = '';
                        // 닫기 버튼만 표시
                        backBtn.textContent = '닫기';
                        backBtn.style.display = 'block';
                        backBtn.onclick = () => window.location.href = 'notice.html';
                    }
                }
                // 케이스 3: 부분 출금 (일부만 출금됨)
                else {
                    resultMessage1.textContent = `보증금 ${withdrawnAmount.toLocaleString()}원 출금이 (일부)처리되지 않았어요.`;
                    resultMessage2.textContent = createBondMessage(remainingDeposit, remainingPrize, '남은 ');
                    
                    hideAllButtons();
                    
                    // 닫기 버튼은 항상 표시
                    closeBtn.onclick = () => window.location.href = 'notice.html';
                    
                    // 채권 신고하기 버튼은 남은 금액이 있을 때만 표시
                    if (hasRemainingAmount) {
                        bondButtons.style.display = 'flex';
                        bondBtn.onclick = () => window.location.href = 'address.html';
                    } else {
                        backBtn.textContent = '닫기';
                        backBtn.style.display = 'block';
                        backBtn.onclick = () => window.location.href = 'notice.html';
                    }
                }
                
                resultSection.style.display = 'block';
            } catch (error) {
                messageEl.className = 'message error show';
                messageEl.textContent = error.message || '처리 중 오류가 발생했습니다.';
            }
        });
    </script>
</body>
</html>

