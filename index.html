<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입력 폼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 100%;
            width: 100%;
            max-width: 600px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="tel"],
        input[type="number"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .message.show {
            display: block;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .edit-notice {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .edit-notice.show {
            display: block;
        }

        .update-timestamp {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 10px;
            border-radius: 4px;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 30px 20px;
                border-radius: 8px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 25px;
            }

            .update-timestamp {
                font-size: 10px;
                padding: 4px 8px;
                bottom: 5px;
                right: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">주소를 불러오는 중...</div>
        </div>
    </div>

    <div class="update-timestamp" id="updateTimestamp"></div>

    <div class="container">
        <h1>입력 폼</h1>

        <form id="submitForm">
            <div class="form-group">
                <label for="user_name">이름 *</label>
                <input type="text" id="user_name" name="user_name" required>
            </div>

            <div class="form-group">
                <label for="user_phone">전화번호 *</label>
                <input type="tel" id="user_phone" name="user_phone" required>
            </div>

            <div class="form-group">
                <label for="deposit">입금액 *</label>
                <input type="number" id="deposit" name="deposit" required>
            </div>

            <div class="form-group">
                <label for="prize">상금액 *</label>
                <input type="number" id="prize" name="prize" required>
            </div>

            <div class="form-group">
                <label for="user_address">주소</label>
                <input type="text" id="user_address" name="user_address">
            </div>

            <div id="message" class="message"></div>
            
            <div class="edit-notice" id="editNotice">
                기존 데이터를 수정합니다.
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">제출</button>
        </form>
    </div>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = 
        'https://script.google.com/macros/s/AKfycbzkaO6dP0iQL7RQaXg8C8_v85WxrMG8VpBPN0UG4lq4uiH5RKmnNm9v9IKpLJ8nbBwL/exec'
        //'https://script.google.com/macros/s/AKfycbz4vhvKd3Vsm_0gv5QcEDZBVYcukqA21qk_3vGoVHPwDpfb3k5-P1VbBqpPyO0qa5o/exec'
        // 'https://script.google.com/macros/s/AKfycbw1J2sCkXzIRcxe0SbEQNR8t0jVIErKOHm0CAt-Ha7C0H4O21WKELujMxZGhM42coWg/exec'


        // URL 파라미터에서 값을 읽어오는 함수
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 고정할 필드 목록 (URL 파라미터로 값이 전달되면 수정 불가능하게 만듦)
        const lockedFields = ['user_name', 'user_phone', 'deposit', 'prize'];

        // 전화번호로 제출 내역 조회
        async function loadSubmissionsByPhone(phone, showLoadingMessage = true) {
            console.log("=== 전화번호로 제출 내역 조회 시작 ===");
            console.log("전화번호:", phone);
            console.log("로딩 메시지 표시:", showLoadingMessage);
            
            if (!phone || phone.trim() === '') {
                console.log("에러: 전화번호가 없습니다.");
                return null;
            }

            try {
                if (showLoadingMessage) {
                    showMessage('정보를 불러오는 중...', 'loading');
                }
                
                const requestUrl = `${SCRIPT_URL}?phone=${encodeURIComponent(phone)}`;
                console.log("요청 URL:", requestUrl);
                console.log("요청 시작 시간:", new Date().toISOString());
                
                const response = await fetch(requestUrl);
                console.log("응답 상태:", response.status, response.statusText);
                
                const data = await response.json();
                console.log("응답 데이터:", JSON.stringify(data));
                console.log("응답 수신 시간:", new Date().toISOString());

                if (data.error) {
                    console.log("에러 응답:", data.error);
                    if (showLoadingMessage) {
                        showMessage(data.error, 'error');
                        setTimeout(hideMessage, 3000);
                    }
                    console.log("=== 조회 완료 (에러) ===");
                    return null;
                }

                if (data.submissions && data.submissions.length > 0) {
                    // 가장 최근 제출 내역 (마지막 항목) 사용
                    const latest = data.submissions[data.submissions.length - 1];
                    console.log("조회된 제출 내역 수:", data.submissions.length);
                    console.log("가장 최근 제출 내역:", JSON.stringify(latest));
                    console.log("=== 조회 완료 (성공) ===");
                    return latest;
                }

                console.log("조회된 제출 내역 없음");
                console.log("=== 조회 완료 (데이터 없음) ===");
                return null;
            } catch (error) {
                console.error('=== 조회 오류 발생 ===');
                console.error('에러 타입:', error.name);
                console.error('에러 메시지:', error.message);
                console.error('에러 스택:', error.stack);
                if (showLoadingMessage) {
                    showMessage('정보를 불러오는 중 오류가 발생했습니다.', 'error');
                    setTimeout(hideMessage, 3000);
                }
                console.log("=== 조회 완료 (예외) ===");
                return null;
            }
        }

        // 조회된 데이터로 폼 채우기
        function fillFormWithData(data) {
            if (!data) return;

            const fields = {
                'name': 'user_name',
                'phone': 'user_phone',
                'address': 'user_address',
                'deposit': 'deposit',
                'prize': 'prize'
            };

            Object.keys(fields).forEach(key => {
                const fieldId = fields[key];
                const input = document.getElementById(fieldId);
                if (input && data[key]) {
                    input.value = data[key];
                    
                    // 고정 필드인 경우 비활성화
                    if (lockedFields.includes(fieldId)) {
                        input.disabled = true;
                    }
                }
            });

            showMessage('이전 제출 내역을 불러왔습니다.', 'success');
            setTimeout(hideMessage, 3000);
        }

        // URL 파라미터로 필드 자동 채우기
        async function fillFieldsFromUrl() {
            const fields = {
                'name': 'user_name',
                'phone': 'user_phone',
                'address': 'user_address',
                'depositAmount': 'deposit',
                'deposit': 'deposit',  // deposit도 지원
                'prizeAmount': 'prize',
                'prize': 'prize'  // prize도 지원
            };

            // URL 파라미터로 직접 값이 전달된 경우
            Object.keys(fields).forEach(urlKey => {
                const value = getUrlParameter(urlKey);
                if (value) {
                    const fieldId = fields[urlKey];
                    const input = document.getElementById(fieldId);
                    if (input) {
                        input.value = decodeURIComponent(value);
                        
                        // 고정 필드인 경우 비활성화
                        if (lockedFields.includes(fieldId)) {
                            input.disabled = true;
                        }
                    }
                }
            });

            // URL 파라미터에 phone이 있고 address가 없으면 주소만 조회해서 채우기
            const phoneParam = getUrlParameter('phone');
            const addressParam = getUrlParameter('address');
            console.log("URL 파라미터 - phone:", phoneParam, "address:", addressParam);
            
            if (phoneParam && !addressParam) {
                console.log("=== 주소 자동 조회 시작 ===");
                // 로딩 오버레이 표시
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.add('show');
                
                try {
                    const submission = await loadSubmissionsByPhone(phoneParam, false);
                    if (submission && submission.address) {
                        console.log("조회된 주소:", submission.address);
                        // 주소만 채우기
                        const addressInput = document.getElementById('user_address');
                        if (addressInput && !addressInput.value) {
                            addressInput.value = submission.address;
                            console.log("주소 필드에 값 설정 완료");
                        }
                        // 기존 데이터 수정 메시지 표시 (사라지지 않음)
                        const editNotice = document.getElementById('editNotice');
                        editNotice.classList.add('show');
                        console.log("기존 데이터 수정 메시지 표시");
                    } else {
                        console.log("등록된 주소 없음");
                        // 주소가 없는 경우
                        showMessage('등록된 주소가 없습니다.', 'info');
                        setTimeout(hideMessage, 2000);
                    }
                    console.log("=== 주소 자동 조회 완료 ===");
                } catch (error) {
                    console.error('=== 주소 조회 오류 발생 ===');
                    console.error('에러 타입:', error.name);
                    console.error('에러 메시지:', error.message);
                    console.error('에러 스택:', error.stack);
                    showMessage('주소를 불러오는 중 오류가 발생했습니다.', 'error');
                    setTimeout(hideMessage, 3000);
                } finally {
                    // 로딩 오버레이 숨기기
                    loadingOverlay.classList.remove('show');
                }
            } else if (phoneParam && addressParam) {
                console.log("주소가 URL 파라미터로 이미 제공됨");
                // 주소가 이미 있는 경우 - 기존 데이터 수정 메시지 표시 (사라지지 않음)
                const editNotice = document.getElementById('editNotice');
                editNotice.classList.add('show');
            }
        }

        // 메시지 표시 함수
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message show ${type}`;
        }

        // 메시지 숨기기
        function hideMessage() {
            const messageEl = document.getElementById('message');
            messageEl.classList.remove('show');
        }

        // localStorage에 제출된 전화번호 저장
        function saveSubmittedPhone(phone) {
            if (phone) {
                const phoneRaw = phone.toString().trim().replaceAll('-', '').replaceAll(' ', '');
                localStorage.setItem('submitted_phone', phoneRaw);
            }
        }

        // localStorage에서 제출된 전화번호 확인
        function hasSubmittedPhone(phone) {
            if (!phone) return false;
            const phoneRaw = phone.toString().trim().replaceAll('-', '').replaceAll(' ', '');
            const savedPhone = localStorage.getItem('submitted_phone');
            return savedPhone && savedPhone === phoneRaw;
        }

        // 전화번호로 데이터 존재 여부 확인
        async function checkDataExists(phone) {
            console.log("=== 데이터 존재 여부 확인 시작 ===");
            console.log("전화번호:", phone);
            
            // localStorage에 저장된 전화번호가 있으면 바로 true 반환
            if (hasSubmittedPhone(phone)) {
                console.log("localStorage에서 데이터 존재 확인됨");
                console.log("=== 데이터 확인 완료 (localStorage) ===");
                return true;
            }
            
            console.log("localStorage에 없음, 서버에 확인 요청");
            
            // localStorage에 없으면 서버에 확인
            try {
                const requestUrl = `${SCRIPT_URL}?phone=${encodeURIComponent(phone)}`;
                console.log("요청 URL:", requestUrl);
                console.log("요청 시작 시간:", new Date().toISOString());
                
                const response = await fetch(requestUrl);
                console.log("응답 상태:", response.status, response.statusText);
                
                const data = await response.json();
                console.log("응답 데이터:", JSON.stringify(data));
                
                const exists = data.submissions && data.submissions.length > 0;
                console.log("데이터 존재 여부:", exists);
                console.log("제출 내역 수:", data.submissions ? data.submissions.length : 0);
                
                // 서버에 데이터가 있으면 localStorage에도 저장
                if (exists) {
                    saveSubmittedPhone(phone);
                    console.log("localStorage에 전화번호 저장 완료");
                }
                
                console.log("=== 데이터 확인 완료 (서버) ===");
                return exists;
            } catch (error) {
                console.error('=== 데이터 확인 오류 발생 ===');
                console.error('에러 타입:', error.name);
                console.error('에러 메시지:', error.message);
                console.error('에러 스택:', error.stack);
                console.log("=== 데이터 확인 완료 (예외) ===");
                return false;
            }
        }

        // 폼 제출 처리
        document.getElementById('submitForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("=== 폼 제출 시작 ===");

            const submitBtn = document.getElementById('submitBtn');
            const formData = {
                user_name: document.getElementById('user_name').value,
                user_phone: document.getElementById('user_phone').value,
                user_address: document.getElementById('user_address').value,
                deposit: document.getElementById('deposit').value,
                prize: document.getElementById('prize').value
            };
            console.log("제출할 폼 데이터:", JSON.stringify(formData));

            // 로딩 상태
            submitBtn.disabled = true;
            submitBtn.textContent = '제출 중...';
            showMessage('제출 중입니다...', 'loading');

            try {
                // 전화번호로 기존 데이터 존재 여부 확인
                console.log("기존 데이터 존재 여부 확인 중...");
                const exists = await checkDataExists(formData.user_phone);
                console.log("기존 데이터 존재 여부:", exists);
                
                // URL 구성: 업데이트인 경우 ?action=update 추가
                const url = exists ? `${SCRIPT_URL}?action=update` : SCRIPT_URL;
                console.log("요청 URL:", url);
                console.log("요청 모드: POST (no-cors)");
                console.log("요청 시작 시간:", new Date().toISOString());
                
                // 모든 요청을 POST로 전송 (no-cors 모드 사용)
                const fetchOptions = {
                    method: "POST",
                    mode: 'no-cors',
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                };
                console.log("요청 옵션:", JSON.stringify(fetchOptions, null, 2));
                
                await fetch(url, fetchOptions);
                console.log("요청 전송 완료 시간:", new Date().toISOString());

                // no-cors 모드에서는 응답을 읽을 수 없으므로 제출 후 바로 성공 메시지 표시
                const successMessage = exists ? '데이터가 수정되었습니다!' : '제출이 완료되었습니다!';
                console.log("성공 메시지:", successMessage);
                showMessage(successMessage, 'success');
                
                // 제출 완료 후 localStorage에 전화번호 저장
                saveSubmittedPhone(formData.user_phone);
                console.log("localStorage에 전화번호 저장 완료");
                
                console.log("=== 폼 제출 완료 (성공) ===");
                
                // 성공 후 폼 초기화 (고정된 필드는 유지)
                setTimeout(() => {
                    const addressField = document.getElementById('user_address');
                    if (!addressField.disabled) {
                        addressField.value = '';
                        console.log("주소 필드 초기화 완료");
                    }
                    hideMessage();
                }, 3000);
            } catch (error) {
                console.error('=== 폼 제출 오류 발생 ===');
                console.error('에러 타입:', error.name);
                console.error('에러 메시지:', error.message);
                console.error('에러 스택:', error.stack);
                console.log("=== 폼 제출 완료 (예외) ===");
                showMessage('제출 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '제출';
                console.log("제출 버튼 상태 복원 완료");
            }
        });

        // 페이지 버전 정보
        const PAGE_VERSION = '1.0.1';
        const BUILD_DATE = '2025-11-14';

        // 버전 표시
        function displayVersion() {
            const versionEl = document.getElementById('updateTimestamp');
            if (versionEl) {
                versionEl.textContent = `v${PAGE_VERSION} (${BUILD_DATE})`;
            }
        }

        // 페이지 로드 시 URL 파라미터로 필드 채우기
        fillFieldsFromUrl();
        
        // 페이지 로드 시 버전 표시
        displayVersion();
    </script>
</body>
</html>
